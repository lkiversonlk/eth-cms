<div class="container">
    <ol class="breadcrumb">
        <li><a href="/">首页</a></li>
        {{#foreach category.breadcrumb}}
            <li><a href="{{path}}">{{name}}</a></li>
        {{/foreach}}
        <li class="active">{{text category.name words="15"}}</li>
    </ol>
    <div class="page-header text-center">
        <h1>{{category.name}}</h1>
    </div>

    <div class="content">
        <ul>
            <li><a href="/tutorial/t5">什么是Ethereum域名</a></li>
            <li><a href="/tutorial/t6">如何注册Ethereum域名</a></li>
            <li><a href="/tutorial/t7">Ethereum域名注册细则</a></li>
        </ul>
        <div class="row">
            <div class="col-md-8">
                <div class="input-group" style="margin-top: 15px">
                    <input id="domain" type="text" class="form-control" placeholder="输入域名（不包括.eth)，回车或者点击右侧.eth" aria-describedby="basic-addon2">
                    <span
                            class="input-group-addon"
                            id="ok"
                            style="
                        cursor: pointer;
                        :hover{
                            background: blue;
                        }
                        "
                    >
                .eth
                    </span>
                </div>

                <div>

                </div>

                <div style="margin-top: 40px;">
                    <table class="table table-striped">
                        <tbody>
                        <tr>
                            <td>当前状态</td>
                            <td id="stch"></td>
                        </tr>
                        <tr>
                            <td>注册时间</td>
                            <td id="date"></td>
                        </tr>
                        <tr>
                            <td>最高出价(以太币)</td>
                            <td id="high"></td>
                        </tr>
                        <tr>
                            <td>第二价格(以太币)</td>
                            <td id="sec"></td>
                        </tr>
                        <tr>
                            <td>以太币实时价格(人民币)</td>
                            <td id="eth_price"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div>
                    <div id="success" style="margin-top: 20px" class="alert alert-success">
                    </div>
                    <div id="error" class="alert alert-danger">
                    </div>

                </div>
            </div>
            <div class="col-md-4">
                <ul id="tweet" class="list-group" style="overflow-y: scroll; max-height: 280px;">

                </ul>
            </div>
        </div>

        <div id="dapps" class="row">
            <div class="row">
                <label>
                    以太坊域名注册Dapp
                </label>
            </div>

            <div class="col-md-8">
                <div id="info" class="alert alert-info">

                </div>
                <div id="start">
                    <button id="startbtn" class="btn btn-success input-group form-control">
                        开启竞拍(请确保域名中没有.等特殊符号，不建议使用大写字母)
                    </button>
                </div>

                <div id="bid" style="margin-top: 15px">
                    <div class="input-group">
                        <input id="bidprice" type="text" class="form-control" placeholder="请输入您的出价" aria-describedby="basic-addon2">
                        <span
                                class="input-group-addon"
                        >
                        ether
                    </span>
                    </div>
                    <br/>
                    <div class="input-group">
                        <input id="secret" type="text" class="form-control" placeholder="请输入加密字符串" aria-describedby="basic-addon2">
                        <span class="input-group-addon">
                           加密字符串泄露会让别人破译您的出价，但不会丢失任何财产
                        </span>
                    </div>
                    <br/>
                    <button id="bidbtn" class="btn btn-success input-group form-control">
                        出价
                    </button>
                </div>

                <div id="bid_v" style="margin-top: 15px">
                    <label>如果您已经出价过，可以在这里复验是否已经生效</label>
                    <div class="input-group">
                        <input id="bidprice_v" type="text" class="form-control" placeholder="请输入您当时出价" aria-describedby="basic-addon2">
                        <span
                                class="input-group-addon"
                        >
                        ether
                    </span>
                    </div>
                    <br/>
                    <div class="input-group">
                        <input id="secret_v" type="text" class="form-control" placeholder="请输入您当时加密字符串" aria-describedby="basic-addon2">
                        <span class="input-group-addon">
                           请保持跟您出价时输入一致
                        </span>
                    </div>
                    <br/>
                    <button id="bidbtn_v" class="btn btn-success input-group form-control">
                        校验
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="application/javascript" src="/javascripts/web3.js"></script>
    <script type="application/javascript" src="/javascripts/dist.js"></script>
    <script type="application/javascript">
        $("#dapps").hide();
        $("#info").hide();

        if(typeof web3 !== 'undefined') {
            // If there's a web3 library loaded, then make your own web3
            var web3 = new Web3(web3.currentProvider);
            $("#info").html("ens域名注册Dapp启动中...");
            $("#info").show();
            $("#dapps").show();
            var clickHook = ensDappStart(web3);
            web3.eth.getAccounts(function(e, a){
                var text = "";
                if(e){
                    text = "获取账户信息失败！" + e.toString();

                } else if(a.length == 0){
                    text = "ens域名注册Dapp启动成功, 但没有eth账户连接";
                } else {
                    text = "ens域名注册Dapp启动成功，连接账户" + a[0];
                }

                setTimeout(function () {
                    $("#info").html(text);
                }, 2000);
            });
        } else {
            // Alert the user he is not in a web3 compatible browser
            setTimeout(function () {
                $("#error").html("要使用注册功能请在mist浏览器中打开本地址");
                $("#error").show();
            }, 2000);
        }
    </script>

    <script type="application/javascript">
        $("#error").hide();
        $("#success").hide();

        toHide = [
            "bid",
            "start",
            "bid_v"
        ];
        toHide.forEach(function (t) { $("#" + t).hide() });

        function Search(){
            var search = $("#domain").val();
            $("#error").html("");
            $("#success").html("");
            $("#error").hide();
            $("#success").hide();

            toHide.forEach(function (t) { $("#" + t).hide() });

            if(search.length < 7){
                if(search.length == 0) {
                    return;
                } else {
                    $("#error").html("域名长度不能小于7， " + search + " 只有" + search.length);
                    $("#error").show();
                    return;
                }
            } else {
                console.log("trying to query domain" + search);
                $.get("/eth/ens?domain=" + search, function (data) {
                    $("#success").html("查询成功");
                    $("#success").show();
                    Object.keys(data).forEach(function(key){
                        if(key === 'date'){
                            var time = new Date(data[key]);
                            $("#date").html(time.toLocaleDateString());
                        } else {
                            $("#"+key).html(data[key]);
                        }
                    });

                    if(clickHook){
                        clickHook(search, data);
                    }
                });

                $.get("/eth/eth_price", function (data) {
                    $("#eth_price").html(data.sell);
                });
            }
        }

        $("#ok").click(Search);
        $('#domain').keypress(function (e) {
            if (e.which == 13) {
                Search();
                return false;    //<---- Add this line
            }
        });

        var startAuction = /^An auction was started/;
        var endAuction = /was just registered/;
        var domain=/\b(\S*\.eth)\b/;
        var price = /\b[\d\.]+ ether\b/;
        function handleEnsBotText(text) {
            if(startAuction.test(text)){
                var match = text.match(domain);
                if(match.length > 0){
                    var domainStr = match[0];
                    return "<li class='list-group-item'>域名" + domainStr + "竞拍刚刚开始</li>";
                }

            }else if(endAuction.test(text)){
                var match = text.match(domain);
                if(match.length > 0){
                    var domainStr = match[0];
                    match = text.match(price);
                    if(match.length > 0){
                        var priceStr = match[0];
                        return "<li class='list-group-item'>域名" + domainStr + " 刚刚被注册，价格:" + priceStr + "</li>";
                    }
                }
            };
        };

        var since_id = null;
        function UpdateTweet(){
            var url = "/twitter";
            if(since_id){
                url += "?since_id="+since_id
            }
            $.get(url, function (data) {
                if(data.error){
                } else {
                    if(data.i == since_id){
                        //return;
                    } else {
                        $("#tweet").html(data.t.map(handleEnsBotText).join("") + $("#tweet").html());
                        since_id = data.i;
                    }
                }
                //setTimeout(UpdateTweet, 10000);
            })
        }

        UpdateTweet();
    </script>

</div>